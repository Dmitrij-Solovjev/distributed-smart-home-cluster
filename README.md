# distributed-smart-home-cluster

Distributed smart home cluster ‚Äî —ç—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —É–º–Ω–æ–≥–æ –¥–æ–º–∞, —Ä–∞–±–æ—Ç–∞—é—â–∞—è –±–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–ª–∞–∫–∞. –ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä Kubernetes –Ω–∞ –±–∞–∑–µ k0s —Å —Å–µ—Ç–µ–≤—ã–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º Kube-Router –∏ –ª—ë–≥–∫–æ–≤–µ—Å–Ω—ã–π –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (NATS). –ö–∞–∂–¥—ã–π —É–∑–µ–ª –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤—ã—Å—Ç—É–ø–∞–µ—Ç —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä–æ–º, –æ–±–º–µ–Ω–∏–≤–∞—è—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ —Ç–æ–ø–∏–∫—É `retr_msg`, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—É—é –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é —Å–≤—è–∑—å –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏. –ë–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ Python-—Å–µ—Ä–≤–∏—Å–∞—Ö –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –¥–µ–ø–ª–æ—é —á–µ—Ä–µ–∑ GitHub Actions (CI/CD), HomeRelayCluster –ª–µ–≥–∫–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –ø–æ–¥ –ª—é–±—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ ¬´—É–º–Ω–æ–≥–æ –¥–æ–º–∞¬ª –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –æ–±–ª–∞—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

---

### üå≥ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (—É—Å—Ç–∞—Ä–µ–ª–∞, –æ–±–Ω–æ–≤–∏—Ç—å)

```bash
distributed-smart-home-cluster
-----------------------------------------------------------------------------------------------------------------------
‚îú‚îÄ‚îÄ k0s-configs/                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è k0s-–∫–ª–∞—Å—Ç–µ—Ä–∞
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ k0sctl.yaml                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è k0sctl (–≤–∫–ª—é—á–∞–µ—Ç NATS, Prometheus Stack, Traefik Ingress Controller)
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ storageclass.yaml           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è StorageClass –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö NATS
‚îÇ
‚îú‚îÄ‚îÄ local_dev_scripts/              # –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å NATS
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ pub.py                      # –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ NATS
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ sub.py                      # –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ NATS
‚îÇ
‚îú‚îÄ‚îÄ pytest.ini                      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Pytest
‚îÇ
‚îú‚îÄ‚îÄ README.md                       # –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
‚îÇ
‚îî‚îÄ‚îÄ relay-service/                  # –°–µ—Ä–≤–∏—Å —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    ‚îú‚îÄ‚îÄ app.py                      # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    ‚îú‚îÄ‚îÄ Dockerfile                  # Docker-–æ–±—Ä–∞–∑ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
    ‚îú‚îÄ‚îÄ requirements.txt            # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python-–ø—Ä–æ–µ–∫—Ç–∞
    ‚îú‚îÄ‚îÄ service.yaml                # –û–ø–∏—Å–∞–Ω–∏–µ Kubernetes-—Å–µ—Ä–≤–∏—Å–∞
    ‚îú‚îÄ‚îÄ statefulset.yaml            # –û–ø–∏—Å–∞–Ω–∏–µ StatefulSet –¥–ª—è Kubernetes
    ‚îî‚îÄ‚îÄ tests/
        ‚îî‚îÄ‚îÄ test_app.py             # –¢–µ—Å—Ç—ã –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Pytest)
```

---

## üöÄ –î–µ–ø–ª–æ–π

### 1. **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ k0s**:

   ```bash
   k0sctl apply --config k0s-configs/k0sctl.yaml
   ```

### 2. **To access your k0s cluster, use k0sctl to generate a kubeconfig for the purpose.**

   ```bash
   k0sctl kubeconfig --config k0s-configs/k0sctl.yaml > k0s-configs/kubeconfig
   ```

### 3. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è KUBECONFIG**

   ```bash
   export KUBECONFIG="$(pwd)/k0s-configs/kubeconfig"
   ```

### 4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∫—É**
   ```bash
    kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
   ```

### 5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Provisioner**
    1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—è–≤–∏–ª–∏—Å—å —Ä–µ—Å—É—Ä—Å—ã –≤ namespace:
   ```bash
   kubectl get ns/local-path-storage                  # namespace —Å–æ–∑–¥–∞–Ω
   kubectl get pods -n local-path-storage             # –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Pod provisioner
   kubectl get sc                                     # StorageClass local-path(default=false)
   ```
   2. –°–¥–µ–ª–∞–π—Ç–µ –µ–≥–æ default:
   ```bash
   kubectl patch storageclass local-path \
      -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
   ```

### 6. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Helm**

   ```bash
   helm repo add nats https://nats-io.github.io/k8s/helm/charts/    # –ø–æ–¥–∫–ª—é—á–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
   helm repo update                                               # –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ —á–∞—Ä—Ç–æ–≤
   ```

### 7. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ NATS —Å JetStream**

    –î–∞–ª–µ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å NATS

   ```bash
    helm upgrade --install my-nats nats/nats -f k0s-configs/nats-values.yaml
   ```


### 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Pods –≤ —Å—Ç–∞—Ç—É—Å–µ `Running`:

   ```bash
   kubectl get pods -l app.kubernetes.io/instance=my-nats
   ```
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤ —Ç—Ä–µ—Ö —Ä–∞–∑–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:

   ```bash
   kubectl port-forward svc/my-nats 4222:4222
   ```
   ```bash
   nats pub test "hello" -s nats://127.0.0.1:4222
   ```
   ```bash
   nats sub test -s nats://127.0.0.1:4222 --timeout 2s
   ```

### 9. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ Kubernetes**:

   ```bash
   kubectl apply -f relay-service/statefullset.yaml
   kubectl apply -f relay-service/service.yaml
   ```

### 10. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞**:

   ```bash
   kubectl get pods,svc,statefulset -n default
   kubectl describe statefulset relay-service
   kubectl describe pod relay-service-0
   ```

### 11. **–ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ –≤—ã–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**

   ```bash
   kubectl rollout restart deployment/relay-service
   ```

